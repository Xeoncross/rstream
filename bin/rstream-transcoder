#!/bin/sh
######################################################################################
### rstream-transcoder
# 
# license: GPL
# 
# authors:
# - Rudolph Sand aka https://github.com/kelexel
# 
# url:
# - https://github.com/kelexel/rstream
#
######################################################################################


clear 

HOME="/home/rstream"
# User to which everything will be setuidgid to
# This only checks & creates the default user test on your system
USER="rstream"

. $HOME/.version

# set DAEMONTOOLS_SERVICE based on default port service path
DAEMONTOOLS_SERVICE="/var/service"

####
### Load OS Core files
####
echo ""
echo ""
##
if [ ! -f $HOME/include/core/rstream-core ]; then echo "!! invalid rstream setup - invalid HOME ?"; exit 99; fi
. $HOME/include/core/rstream-core

####
### Load OS Core files
####
case `uname -s` in
	FreeBSD) system_os="freebsd9";;
	*) echo "!! Sorry, but your current Operating System is not supported yet, exiting." exit 2;;
esac
echo "########## rstream-transcoder-$TAG for rstream $TAG on $system_os"
echo ""
. $HOME/include/${system_os}/rstream-${system_os}_common-helper
. $HOME/etc/rstream.conf
. $HOME/include/${system_os}/rstream-${system_os}_crtmpd-helper
. $HOME/include/${system_os}/rstream-${system_os}_daemontools-helper
. $HOME/include/${system_os}/rstream-${system_os}_nginx-helper
. $HOME/include/${system_os}/rstream-${system_os}_ffmpeg-helper
rstream-core-init




transcodeInit(){
	proto=$1
	dest_host=$2
	dest_port=$3
	dest_app=$4
	stream=$5
	# a bit of logic ..
	dest_720="$proto://${dest_host}:${dest_port}/r/${stream}_720p"
	dest_480="$proto://${dest_host}:${dest_port}/r/${stream}_480p"
	dest_360="$proto://${dest_host}:${dest_port}/r/${stream}_360p"
	dest_240="$proto://${dest_host}:${dest_port}/r/${stream}_240p"

	ffmpeg_bin="/usr/local/bin/ffmpeg"
}

# nginx transcoding - working as of 0.4
transcoderNginx(){
	if [ -z $FFMPEG_NGINX_ENABLE ] || [ ! $FFMPEG_NGINX_ENABLE -eq 1 ]; then echo "Error: \"-run nginx <streamname>\" supplied, but FFMPEG_NGINX_ENABLE is not set to \"1\" in $HOME/etc/rstream.conf, exiting !"; exit 98; fi

	app="proxy"
	dest_app="r"
	if [ -z $1 ]; then echo "!! error missing stream name, exiting !!"; exit 99; fi
	stream=$1

	src="rtmp://$NGINX_RTMP_IP:$NGINX_RTMP_PORT/$app/$stream"
	transcodeInit "rtmp" $NGINX_RTMP_IP $NGINX_RTMP_PORT $dest_app $stream

	checkDir $HOME/tmp/nginx/hls -c www 777;

	echo "*+ generating new ${stream}.m3u8 playlist";
	echo "#EXTM3U" > $HOME/tmp/nginx/hls/${stream}.m3u8
	echo "#EXT-X-STREAM-INF:PROGRAM-ID=1, BANDWIDTH=860000" >> $HOME/tmp/nginx/hls/${stream}.m3u8
	echo "${stream}_72Op.m3u8" >> $HOME/tmp/nginx/hls/${stream}.m3u8
	echo "#EXT-X-STREAM-INF:PROGRAM-ID=1, BANDWIDTH=512000" >> $HOME/tmp/nginx/hls/${stream}.m3u8
	echo "${stream}_480p.m3u8" >> $HOME/tmp/nginx/hls/${stream}.m3u8
	echo "#EXT-X-STREAM-INF:PROGRAM-ID=1, BANDWIDTH=396000" >> $HOME/tmp/nginx/hls/${stream}.m3u8
	echo "${stream}_360p.m3u8" >> $HOME/tmp/nginx/hls/${stream}.m3u8
	echo "#EXT-X-STREAM-INF:PROGRAM-ID=1, BANDWIDTH=256000" >> $HOME/tmp/nginx/hls/${stream}.m3u8
	echo "${stream}_360p.m3u8" >> $HOME/tmp/nginx/hls/${stream}.m3u8

	#ffmpeg_bin=/home/rstream/bin/ffmpeg
	cmd="$cmd -re -acodec libfaac -ar 44100 -b:a 96k -vcodec libx264 -s 1280x720 -b:v 500k -metadata streamName=${stream}_720p -f flv $dest_720"
	cmd="$cmd -re -acodec libfaac -ar 44100 -b:a 96k -vcodec libx264 -s 854x480 -b:v 500k -f flv $dest_480"
	cmd="$cmd -re -acodec libfaac -ar 22050 -b:a 96k -vcodec libx264 -s 640x360 -b:v 300k -f flv $dest_360"
	cmd="$cmd -re -acodec libfaac -ar 22050 -b:a 48k -vcodec libx264 -s 426x250 -b:v 100k -f flv $dest_240"
	echo ""
	logHeader "Running $ffmpeg_bin -loglevel 1 -verbosity 1 -threads 15 -nice 10 -i \"$src live=1\"  $cmd"
	echo
	exec $ffmpeg_bin  -i "$src live=1" $cmd
}

transcoderCrtmpd(){
	if [ -z $FFMPEG_CRTMPD_ENABLE ] || [ ! $FFMPEG_CRTMPD_ENABLE -eq 1 ]; then echo "Error: \"-run crtmpd <streamname>\" supplied, but FFMPEG_CRTMPD_ENABLE is not set to \"1\" in $HOME/etc/rstream.conf, exiting !"; exit 98; fi

	# hls_iphone="$HOME/etc/ffmpeg-presets/libx264-ipod320.ffpreset"
	# hls_ipad="$HOME/etc/ffmpeg-presets/libx264-ipod640.ffpreset"
	if [ -z $1 ]; then echo "!! error missing stream name, exiting !!"; exit 99; fi

	app="proxy"
	dest_app="r"
	stream=$1


#	if [ ! -z $2 ] && [ $2 = "-i" ]; then
#		echo "*+ generating new ffmpeg/run script";
#		checkDir $HOME/tmp/ffmpeg -c rstream 700
#		checkDir $HOME/var/log/ffmpeg -c rstream 700
#		checkDir $HOME/var/supervise/ffmpeg-nginx-${stream}/log -c rstream 755
#		cat $HOME/include/templates/ffmpeg-run.tpl \
#			| sed s,_HOME_,$HOME,g \
#			| sed s,_USER_,$USER,g \
#			| sed s,_STREAM_,$stream,g \
#			| sed s,_DAEMON_,'nginx',g \
#			> $HOME/var/supervise/ffmpeg-nginx-${stream}/run
#			chmod 755 $HOME/var/supervise/ffmpeg-nginx-${stream}/run
#		echo "*+ generating new ffmpeg/run/log script";
#		cat $HOME/include/templates/ffmpeg-run-log.tpl \
#			| sed s,_HOME_,$HOME,g \
#			| sed s,_USER_,$USER,g \
#			> $HOME/var/supervise/ffmpeg-nginx-${stream}/log/run
#			chmod 755 $HOME/var/supervise/ffmpeg-nginx-${stream}/log/run
#			exit 0;
#	fi

	src="rtmp://$CRTMPD_RTMP_IP:$CRTMPD_RTMP_PORT/$app/$stream"

	transcodeInit "tcp" $CRTMPD_LIVEFLV_IP $CRTMPD_LIVEFLV_PORT $stream
	#ffmpeg_bin=/home/rstream/bin/ffmpeg
	cmd="$cmd -re -acodec libfaac -ar 44100 -b:a 96k -vcodec libx264 -s 1280x720 -b:v 860k -f flv -metadata streamName=${stream}_720p -f flv $dest_720"
	cmd="$cmd -re -acodec libfaac -ar 44100 -b:a 96k -vcodec libx264 -s 854x480 -b:v 512k -f flv -metadata streamName=${stream}_480p -f flv $dest_480"
	cmd="$cmd -re -acodec libfaac -ar 22050 -b:a 96k -vcodec libx264 -s 640x360 -b:v 396k -f flv -metadata streamName=${stream}_360p -f flv $dest_360"
	cmd="$cmd -re -acodec libfaac -ar 22050 -b:a 48k -vcodec libx264 -s 426x250 -b:v 256k -f flv -metadata streamName=${stream}_240p -f flv $dest_240"
	#if [ ! -z $FFMPEG_HLS ] && [ $FFMPEG_HLS -eq 1 ]; then
	#	hls_iphone="libx264-ipod320"
	#	hls_ipad="libx264-ipod640"
	#	cmd=" -re -an -c:v libx264 -b:v 128k  -vpre $hls_iphone -flags -global_header -map 0 -f segment -segment_time 4 -segment_list $HLS_PATH/$app/$stream/${stream}_iphone.m3u8 -segment_format mpegts $HLS_PATH/$app/iphone/stream%05d.ts"
	#	cmd=" -re -an -c:v libx264 -b:v 256k -vpre $hls_ipad -flags -global_header -map 0 -f segment -segment_time 4 -segment_list $HLS_PATH/$app/$stream/${stream}_ipad.m3u8 -segment_format mpegts $HLS_PATH/ipad/$stream/stream%05d.ts"
	#fi
	echo ""
	logHeader "Running $ffmpeg_bin -threads 15 -i \"$src live=1\"  $cmd"
	echo
	exec $ffmpeg_bin -i "$src live=1" $cmd
}



transcoderMethod3(){
	if [ -z $FFMPEG_CRTMPD_TO_NGINX_TRANSCODING ] || [ ! $FFMPEG_CRTMPD_TO_NGINX_TRANSCODING -eq 1 ]; then echo "Error: \"-run m2\" supplied, but FFMPEG_CRTMPD_TO_NGINX_TRANSCODING is not set to \"1\" in $HOME/etc/rstream.conf, exiting !"; exit 98; fi

app="proxy"
stream=$1
src="rtmp://$CRTMPD_RTMP_IP:$CRTMPD_RTMP_PORT/$app/$stream"
HLS_PATH="$HOME/tmp/ffmpeg/hls"
echo $HLS_PATH/iphone;
checkDir "$HLS_PATH/iphone" -c www 777
checkDir "$HLS_PATH/ipad" -c www 777

	# hls_iphone="$HOME/etc/ffmpeg-presets/libx264-ipod320.ffpreset"
	# hls_ipad="$HOME/etc/ffmpeg-presets/libx264-ipod640.ffpreset"
	hls_iphone="libx264-ipod320"
	hls_ipad="libx264-ipod640"
	transcodeInit "rtmp" $NGINX_RTMP_IP $NGINX_RTMP_PORT $stream

	#ffmpeg_bin=/home/rstream/bin/ffmpeg
#	cmd="$cmd -re -acodec libfaac -ar 44100 -b:a 96k -vcodec libx264 -s 1280x720 -b:v 500k -f flv $dest_720"
#	cmd="$cmd -re -acodec libfaac -ar 44100 -b:a 96k -vcodec libx264 -s 854x480 -b:v 500k -f flv $dest_480"
#	cmd="$cmd -re -acodec libfaac -ar 22050 -b:a 96k -vcodec libx264 -s 640x360 -b:v 300k -f flv $dest_360"
#	cmd="$cmd -re -acodec libfaac -ar 22050 -b:a 48k -vcodec libx264 -s 426x250 -b:v 100k -f flv $dest_240"
##	if [ ! -z $FFMPEG_HLS ] && [ $FFMPEG_HLS -eq 1 ]; then
##		checkDir $HOME/tmp/hls/ipad/$stream -c www 777
##		checkDir $HOME/tmp/hls/iphone/$stream -c www 777
##		checkDir "$HLS_PATH/$app/iphone" -rc
#		cmd=" -re -an -c:v libx264 -b:v 128k -f segment -segment_time 4 -segment_list $HLS_PATH/$app/$stream/${stream}_iphone.m3u8 -segment_format mpegts $HLS_PATH/iphone/stream%05d.ts"
	cmd="$cmd -re -acodec libfaac -ar 22050 -b:a 96k -vcodec libx264 -s 640x360 -b:v 300k -f segment -segment_time 4 -segment_list $HLS_PATH/iphone/${stream}_iphone.m3u8 -segment_format mpegts $HLS_PATH/iphone/stream%05d.ts"
##		checkDir "$HLS_PATH/$app/ipad" -rc
##		cmd=" -re -an -c:v libx264 -b:v 256k -vpre $hls_ipad -flags -global_header -map 0 -f segment -segment_time 4 -segment_list $HLS_PATH/$app/$stream/${stream}_ipad.m3u8 -segment_format mpegts $HLS_PATH/ipad/$stream/stream%05d.ts"
##	fi
	echo ""
	logHeader "Running $ffmpeg_bin -threads 15 -i \"$src live=1\"  $cmd"
	echo
	exec $ffmpeg_bin -threads 15 -i "$src live=1" $cmd
}

routeTranscoder(){

	if [ -z $1 ]; then routeHelp; exit 99; fi
	case $1 in
		-run)
			if [ -z $2 ]; then routeHelp; exit 99; fi
			case $2 in
				crtmpd) transcoderCrtmpd $3;; # CRTMPD (RTMP / FLV) > ffmpeg > CRTMPD (tcvp / FLV)
				nginx) transcoderNginx $3;; # CRTMPD (RTMP / FLV) > ffmpeg > NGINX (rtmp / FLV)
				*) routeHelp;;
			esac
		;;
		-service-create) ffmpeg-router "create" $3;;
		-service-link) ffmpeg-router "link" $3;;
	esac
}


routeTranscoder $1 $2 $3 $4

#### Below lies the graveyard of my ffmpeg tests..

#checkDir $HLS_PATH/$app/$stream -rc

# From https://groups.google.com/forum/#!topic/c-rtmp-server/bzsV61wJGHg[1-25]
#ffmpeg -i "rtmp://localhost:1935/live/mystream live=1" -fpre "/usr/share/ffmpeg/libx264-ipod640.ffpreset" -vcodec libx264 -acodec aac -ac 2 -ar 44100 -ab 127k -strict experimental -f flv "rtmp://localhost:1935/live/mystream_recode live=1"


#-re -acodec libfaac -ar 22050 -b:a 96 -vcodec libx264 -s svga -b:v 500k -f flv "rtmp://localhost:1935/live/test_500?authmod=adobe&login=broadcast&password=n3rox flashver=FMLE/3.0\20(compatible;\20FMSc/1.0)"
#-re -acodec libfaac -ar 22050 -vcodec libx264 -s svga -b:v 500k -f flv "rtmp://localhost:1935/live/test_500?login=broadcast&password=n3rox flashver=FMLE/3.0\20(compatible;\20FMSc/1.0)"
#-re -acodec libfaac -ar 22050 -vcodec libx264 -s svga -b:v 500k -f flv "/home/stream/docs/test_500b.flv"
#ffmpeg -i "rtmp://localhost/live/test live=1" \
#-re -acodec libfaac -ar 22050 -vcodec libx264 -s svga -b:v 500k -f flv "rtmp://localhost/live/test_500" 

#-re -acodec libfaac -ar 22050 -vcodec libx264 -s vga -b 300k -f flv "rtmp://localhost/live/test_300" 
#

#ffmpeg -threads 15 -i "rtmp://localhost/live/test live=1" \
#-re -acodec libfaac -ar 22050 -vcodec libx264 -s svga -b 500k -f flv "rtmp://localhost/live/test_500" \
#-re -acodec libfaac -ar 22050 -vcodec libx264 -s vga -b 300k -f flv "rtmp://localhost/live/test_300" \
#-re -acodec libfaac -ar 22050 -vcodec libx264 -s qvga -b 150k -f flv "rtmp://localhost/live/test_150" \
#-re -acodec libfaac -ar 22050 -vcodec libx264 -s qqvga -b 50k -f flv "rtmp://localhost/live/test_50"



# -f flv "rtmp://live.justin.tv/app/$STREAM_KEY flashver=FMLE/3.0\20(compatible;\20FMSc/1.0)"  

#routeTranscoder $1 $2

# nice and clean ..
echo ""
echo "> done"
echo ""
exit 0;
